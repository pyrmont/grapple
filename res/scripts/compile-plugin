#!/usr/bin/env bash

set -e  # Exit on error

echo "Compiling Fennel plugin files to Lua..."

# Compile by opening each Fennel file and writing it (triggering nfnl's on-save hook)
cd res/plugins/grapple.nvim

# Use find to locate all .fnl files in grapple (excluding test directories)
find fnl/grapple -name "*.fnl" -type f | while read -r fnl_file; do
  echo "  Compiling $fnl_file..."
  if ! nvim --headless -n \
    --cmd "set rtp+=." \
    +"lua require('nfnl').setup()" \
    -c "edit $fnl_file" \
    -c "write" \
    -c "qa" 2>&1 | grep -v "^$"; then
    echo "  ERROR: Failed to compile $fnl_file"
    cd ../../..
    exit 1
  fi
done

cd ../../..

echo "Compilation complete!"
